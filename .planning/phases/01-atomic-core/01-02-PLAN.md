---
phase: 01-atomic-core
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/booking.ts
  - src/actions/reserve.ts
  - scripts/seed.ts
  - scripts/test-concurrency.ts
autonomous: true
must_haves:
  truths:
    - "Tickets cannot be double-sold"
    - "Inventory count is accurate under load"
    - "Held tickets expire correctly"
  artifacts:
    - path: "src/lib/booking.ts"
      provides: "Atomic reservation logic"
      contains: "skipLocked"
    - path: "scripts/test-concurrency.ts"
      provides: "Verification script"
  key_links:
    - from: "src/lib/booking.ts"
      to: "src/db/schema.ts"
      via: "db.transaction"
---

<objective>
Implement the core atomic booking logic and verify it against race conditions.

Purpose: Ensure zero overselling by implementing `FOR UPDATE SKIP LOCKED` and verifying with a concurrency script.
Output: Validated reservation logic and a passing concurrency test suite.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/STACK.md
@.planning/phases/01-atomic-core/01-01-SUMMARY.md
@src/db/schema.ts
@src/db/index.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Seed Test Data</name>
  <files>scripts/seed.ts</files>
  <action>
    Create a script to populate the database with a test event and 100 tickets.
    Use `tsx` to run the script.
    Ensure tickets are initialized as 'AVAILABLE'.
  </action>
  <verify>Run script, check DB count = 100</verify>
  <done>Database has test data</done>
</task>

<task type="auto">
  <name>Task 2: Implement Atomic Reservation Logic</name>
  <files>src/lib/booking.ts</files>
  <action>
    Implement `reserveTicket(eventId, quantity)` function.

    CRITICAL LOGIC:
    1. Start Transaction.
    2. Select `quantity` tickets WHERE event_id = X AND status = 'AVAILABLE'
    3. Add `FOR UPDATE SKIP LOCKED` to the selection query.
    4. If found < quantity, throw "SOLD OUT".
    5. Update selected tickets to 'HELD' with `hold_expires_at = now() + 5min`.
    6. Create `booking_intent` record.
    7. Commit.

    Use Drizzle's transaction API.
  </action>
  <verify>Function exists and type checks</verify>
  <done>Atomic logic implemented</done>
</task>

<task type="auto">
  <name>Task 3: Create Concurrency verification Script</name>
  <files>scripts/test-concurrency.ts</files>
  <action>
    Create a script that:
    1. Resets inventory to 10 tickets.
    2. Spawns 50 concurrent promises calling `reserveTicket(..., 1)`.
    3. Awaits all results.
    4. Counts successes (should be exactly 10).
    5. Counts failures (should be exactly 40).
    6. Verifies DB state (0 AVAILABLE, 10 HELD).

    This proves the "Zero Overselling" requirement.
  </action>
  <verify>Run script and verify output matches expected counts</verify>
  <done>Concurrency safety proven</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsx scripts/test-concurrency.ts` passes with correct numbers
- [ ] No deadlocks observed during test
- [ ] "Sold Out" errors are handled gracefully
</verification>

<success_criteria>
- Atomic reservation function works
- Concurrency test proves zero overselling
- Code handles high contention without crashing
</success_criteria>

<output>
After completion, create `.planning/phases/01-atomic-core/01-02-SUMMARY.md`
</output>
