---
phase: 01-atomic-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - drizzle.config.ts
  - src/db/index.ts
  - src/db/schema.ts
  - .env.local
autonomous: true
user_setup:
  - service: vercel
    why: "Database hosting required for schema deployment"
    env_vars:
      - name: POSTGRES_URL
        source: "Vercel Dashboard → Storage → Connect → .env.local"
    dashboard_config:
      - task: "Create Vercel Project"
        location: "Vercel Dashboard → Add New → Project"
        details: "Name: surge-safe-booking"
      - task: "Create Postgres Database"
        location: "Vercel Dashboard → Storage → Create → Postgres"
        details: "Name: surge-db, Region: Washington, D.C. (iad1) - or closest"
      - task: "Connect Database to Project"
        location: "Vercel Dashboard → Projects → [Project] → Settings → Data"
    local_dev:
      - "vercel link"
      - "vercel env pull .env.local"

must_haves:
  truths:
    - "Database connection is established"
    - "Schema tables exist in database"
    - "TypeScript types are generated from schema"
  artifacts:
    - path: "src/db/schema.ts"
      provides: "Database schema definitions"
      exports: ["events", "tickets", "bookingIntents"]
    - path: "src/db/index.ts"
      provides: "Drizzle client instance"
      exports: ["db"]
    - path: "drizzle.config.ts"
      provides: "Migration configuration"
  key_links:
    - from: "src/db/index.ts"
      to: "POSTGRES_URL"
      via: "process.env"
---

<objective>
Initialize project structure, install core stack dependencies, and deploy the initial database schema.

Purpose: Establish the persistent storage foundation required for the booking engine.
Output: Next.js app configured with Drizzle ORM and a deployed Postgres schema.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK.md

# Stack Decisions from Research:
# - Framework: Next.js 15 (App Router)
# - Database: Vercel Postgres (Neon)
# - ORM: Drizzle ORM (for atomic locking support)
# - Validation: Zod
</context>

<tasks>
<task type="auto">
  <name>Task 1: Initialize Next.js Project</name>
  <files>package.json, tsconfig.json</files>
  <action>
    Initialize a new Next.js 15 project with TypeScript, ESLint, and Tailwind CSS.
    Clean up default boilerplate (page.tsx, globals.css).
    Ensure `package.json` scripts are set up.
  </action>
  <verify>npm run dev starts the server</verify>
  <done>Clean Next.js project structure exists</done>
</task>

<task type="auto">
  <name>Task 2: Install and Configure Drizzle</name>
  <files>package.json, drizzle.config.ts, src/db/index.ts</files>
  <action>
    Install `drizzle-orm`, `@vercel/postgres`, `dotenv`.
    Install dev dependencies: `drizzle-kit`, `tsx`.
    Create `src/db/index.ts` to export the `db` client using `@vercel/postgres`.
    Create `drizzle.config.ts` pointing to `src/db/schema.ts`.
  </action>
  <verify>Drizzle config is valid (npx drizzle-kit --help works)</verify>
  <done>Drizzle ORM installed and configured</done>
</task>

<task type="auto">
  <name>Task 3: Define Database Schema</name>
  <files>src/db/schema.ts</files>
  <action>
    Define tables using Drizzle:
    1. `events`: id (uuid), name, total_tickets, start_date
    2. `tickets`: id (serial/uuid), event_id (fk), status (enum: AVAILABLE, HELD, SOLD), hold_expires_at, version (int, for OCC if needed)
    3. `booking_intents`: id (uuid), status, expires_at, created_at

    Ensure strict typing with Zod inference if useful, but core Drizzle definitions are priority.
  </action>
  <verify>Schema file compiles without TypeScript errors</verify>
  <done>Tables defined in code</done>
</task>

<task type="auto">
  <name>Task 4: Generate and Push Migrations</name>
  <files>drizzle/meta, src/db/migrations/*</files>
  <action>
    Run `drizzle-kit generate` to create SQL migrations.
    Run `drizzle-kit push` (or migrate) to apply to the Vercel Postgres database (requires .env.local from user_setup).
  </action>
  <verify>Database has tables (inspect with Vercel dashboard or drizzle-kit studio)</verify>
  <done>Schema deployed to production DB</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` passes
- [ ] Database connection works
- [ ] Tables exist in the database
</verification>

<success_criteria>
- Next.js app running
- Drizzle client configured
- Schema deployed to Postgres
</success_criteria>

<output>
After completion, create `.planning/phases/01-atomic-core/01-01-SUMMARY.md`
</output>
